@using PKHeX.Web.BackendApi
@implements IDisposable
@inject IMessageService MessageService

@code {

    private int _uploadCount;
    private int _queueSize;
    
    protected override void OnInitialized()
    {
        SyncPokemonWorker.PokemonUploadStarted += HandlePokemonUploadStarted;
        SyncPokemonWorker.PokemonUploaded += HandlePokemonUploaded;
        SyncPokemonWorker.PokemonUploadEnded += HandlePokemonUploadEnded;
    }

    private async Task HandlePokemonUploadStarted(PokemonUploadStartedArgs arg)
    {
        _queueSize = arg.QueueSize;
        
        await MessageService.Loading(new MessageConfig
        {
            // todo: add link to see the queue
            Content = "Synchronizing...",
            Key = "pokemon-sync-toast",
            Duration = 5
        });
    }

    private Task HandlePokemonUploaded(PokemonUploadedArgs arg)
    {
        _uploadCount++;
        return Task.CompletedTask;
    }
    
    private async Task HandlePokemonUploadEnded(EventArgs arg)
    {
        _queueSize = 0;
        _uploadCount = 0;
        
        await MessageService.Success(new MessageConfig
        {
            Content = "Synchronizing completed",
            Key = "pokemon-sync-toast",
            Duration = 3
        });
    }

    public void Dispose()
    {
        SyncPokemonWorker.PokemonUploaded -= HandlePokemonUploaded;
        SyncPokemonWorker.PokemonUploadStarted -= HandlePokemonUploadStarted;
        SyncPokemonWorker.PokemonUploadEnded -= HandlePokemonUploadEnded;
    }

}